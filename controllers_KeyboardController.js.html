<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>controllers/KeyboardController.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module.exports.html">exports</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addNotesToTask">addNotesToTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addTask">addTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#autoSelectTask">autoSelectTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#browserNotify">browserNotify</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#cancelInput">cancelInput</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearCompletedList">clearCompletedList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#closeSettings">closeSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createNotificationBody">createNotificationBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createNotificationTitle">createNotificationTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deselectTaskIfComplete">deselectTaskIfComplete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#disableDistractionMarker">disableDistractionMarker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#displayInputBox">displayInputBox</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#dprint">dprint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#enableDistractionMarker">enableDistractionMarker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#expandCompletedTasks">expandCompletedTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#handleEnter">handleEnter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#handleSpace">handleSpace</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#handleTab">handleTab</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideCompletedIfNoTasksExist">hideCompletedIfNoTasksExist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#idle">idle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#idleAtWorkSession">idleAtWorkSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#incrementDistraction">incrementDistraction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#incrementIdx">incrementIdx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#listChanged">listChanged</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadSettings">loadSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadStoredInputValues">loadStoredInputValues</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadTasks">loadTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadTimerSettings">loadTimerSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#makeTasksDraggable">makeTasksDraggable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#notifyUser">notifyUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#onKeyDown">onKeyDown</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#openSettings">openSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#performLongBreakSession">performLongBreakSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#performPomodoroSession">performPomodoroSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#performShortBreakSession">performShortBreakSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#performWorkSession">performWorkSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#prepareTimerForStart">prepareTimerForStart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#refreshTaskItemIds">refreshTaskItemIds</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#resetInputBox">resetInputBox</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#resetToWorkSession">resetToWorkSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#run">run</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#runLongBreak">runLongBreak</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#runShortBreak">runShortBreak</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#runWorkSession">runWorkSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveSettings">saveSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#selectTask">selectTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setDefaultValuesInStorage">setDefaultValuesInStorage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSession">setSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSessionTimeAndTitle">setSessionTimeAndTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setTime">setTime</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setTitle">setTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showFullTaskList">showFullTaskList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showSelectedTask">showSelectedTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#step">step</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stop">stop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stopIdling">stopIdling</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#styleTimerForLongBreak">styleTimerForLongBreak</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#styleTimerForShortBreak">styleTimerForShortBreak</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#styleTimerForWorkSession">styleTimerForWorkSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#styleTimerUI">styleTimerUI</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleSession">toggleSession</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#unclickItems">unclickItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#unselectOtherTasks">unselectOtherTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateSelectedTaskSessionCount">updateSelectedTaskSessionCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateSettings">updateSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateStorage">updateStorage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateTaskList">updateTaskList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateTimerTime">updateTimerTime</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#viewAll">viewAll</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/KeyboardController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* This class initializes EventListeners that handles specific key presses.
* Keys Currently Bound:
*  - enter: interact with tasks or addTask button
*  - tab: loop through the list of tasks and the add task button
*  - space: start/end the timer (restricted when editing text fields)
*/
export default class KeyboardController {
  constructor() {
    this.DEBUG = true;
    this.DOM_ELEMENTS = {
      timerButton: document.getElementById('start'),
      taskList: document.getElementById('to-do-list'),
      addTaskButton: document.getElementById('add-task'),
      confirmTaskButton: document.getElementById('save-task'),
      expansionLabel: document.getElementById('view-all'),
      inputBox: document.getElementById('task-add-input'),
      inputTextField: document.getElementById('add-task-name'),
      inputMultiField: document.getElementById('pomos'),
      notesButton: document.getElementById('add-notes'),
      notesTextField: document.getElementById('add-task-description'),
      cancelInput: document.getElementById('cancel-input'),
      acceptInput: document.getElementById('save-task'),
    };

    // All keys in this have their default keyup behaviour prevented
    this.KEYS = {
      spacebar: ' ',
      tab: 'Tab',
      enter: 'Enter',
      equals: 'Equals',
      expand1: '=',
      expand2: '+',
      right_arrow: 'ArrowRight',
      shift: 'Shift',
    };

    this.modStatus = false;

    this.focusIdx = 0;
    this.kbMutex = false;
    this.DOM_ELEMENTS.inputBox.focus();

    // bind functions
    this.onKeyDown = this.onKeyDown.bind(this);
    this.dprint = this.dprint.bind(this);
    this.incrementIdx = this.incrementIdx.bind(this);

    // add key listener
    document.addEventListener('keydown', this.onKeyDown, false);

    // remove keyup actions on input elements
    document.querySelector('input').addEventListener('keyup', (e) => {
      // generate a blacklist from the values of keycodes
      if (e.key !== this.KEYS.shift &amp;&amp; Object.values(this.KEYS).includes(e.key)) {
        e.preventDefault();
      }
    });

    // add keyup listener
    document.addEventListener('keyup', (e) => { if (e.key === this.KEYS.shift) this.modUp(); }, false);

    this.DOM_ELEMENTS.inputBox.focus();
  }

  /**
  * Checks key press ID and handles accordingly
  * @param {*} event the event object passed by an EventListener
  */
  onKeyDown(event) {
    console.log(`focus index: ${this.focusIdx}`);

    switch (event.key) {
      case this.KEYS.spacebar:
        this.handleSpace();
        break;
      case this.KEYS.tab:
        this.handleTab(event);
        break;
      case this.KEYS.enter:
        this.handleEnter(event);
        break;
      case this.KEYS.right_arrow:
        this.handleRightArrow(event);
        break;
      case this.KEYS.expand1:
        this.handleExpand(event);
        break;
      case this.KEYS.expand2:
        this.handleExpand(event);
        break;
      case this.KEYS.shift:
        this.modDown();
        break;
      default:
    }
  }

  /**
  * handles the space keypress, is restricted when editing text fields
  */
  handleSpace() {
    const taskInputElements = this.getInputElements();
    const isInputActive = taskInputElements.includes(document.activeElement);
    if (isInputActive) return;

    this.DOM_ELEMENTS.timerButton.click();
  }

  /**
  * handles the tab keypress
  * @param {event} event the event object passed by an EventListener
  * @param {*} mutex a boolean used to restrict/negate function flow
  */

  handleTab(event) {
    // prevent default tab function
    event.preventDefault();
    event.stopImmediatePropagation();

    const cantBeTabbed = this.isTimerInSession() || document.activeElement === document.querySelector('task-input');
    if (cantBeTabbed) return;

    // increment if not focused on text fields
    const isFocusedOnInput = this.DOM_ELEMENTS.inputBox.style.display
      &amp;&amp; this.DOM_ELEMENTS.inputBox.style.display !== 'none';
    if (!isFocusedOnInput) {
      // if shift is not held down then increment, else decrement
      if (this.modStatus) {
        this.decrementIdx();
      } else {
        this.incrementIdx();
      }
    }

    // if the current focus is not a task then it must be the add task button
    if (this.focusIdx === 0) {
      const isInputActive = this.getInputElements().includes(document.activeElement);
      if (!isInputActive) {
        try {
          this.unclickItems();
        } catch (e) {
          this.dprint('No children to unclick');
        }
        this.DOM_ELEMENTS.inputBox.focus();
      } else {
        switch (document.activeElement) {
          case this.DOM_ELEMENTS.inputTextField:
            this.DOM_ELEMENTS.inputMultiField.focus();
            break;
          case this.DOM_ELEMENTS.inputMultiField:
            const isNotesInputDisplayed = this.DOM_ELEMENTS.notesTextField.style.display
              &amp;&amp; this.DOM_ELEMENTS.notesTextField.style.display !== 'none';
            if (isNotesInputDisplayed) {
              this.DOM_ELEMENTS.notesTextField.focus();
            } else {
              this.DOM_ELEMENTS.notesButton.focus();
            }
            break;
          case this.DOM_ELEMENTS.notesButton:
            this.DOM_ELEMENTS.cancelInput.focus();
            break;
          case this.DOM_ELEMENTS.notesTextField:
            this.DOM_ELEMENTS.notesButton.focus();
            break;
          case this.DOM_ELEMENTS.cancelInput:
            this.DOM_ELEMENTS.acceptInput.focus();
            break;
          case this.DOM_ELEMENTS.acceptInput:
            this.DOM_ELEMENTS.inputTextField.focus();
            break;
          default:
        }
      }
    } else {
      // collapse add task form if possible
      this.DOM_ELEMENTS.cancelInput.click();

      // focus on the current task and highlight it
      this.DOM_ELEMENTS.taskList.children[this.focusIdx - 1].focus();
      document.activeElement.click();
    }
  }

  /**
  * handles the enter keypress
  * @param {event} event the event object passed by an EventListener
  * @param {*} mutex a boolean used to restrict/negate function flow
  */
  handleEnter(event) {
    const isInEditInput = document.activeElement === document.querySelector('task-input');
    if (isInEditInput) return;

    event.preventDefault();
    // handle enter on &lt;add-task-button>
    if (this.focusIdx === 0) {
      // If the form is not open then open it
      if (this.isTimerInSession()) return;
      const isAddTaskFormHidden = !this.DOM_ELEMENTS.inputBox.style.display
        || this.DOM_ELEMENTS.inputBox.style.display === 'none';
      if (isAddTaskFormHidden) {
        this.DOM_ELEMENTS.addTaskButton.click();
        this.DOM_ELEMENTS.inputTextField.focus();
      } else if (document.activeElement === this.DOM_ELEMENTS.notesButton) {
        // the form is open and we are focused on adding notes, so open the notes text form
        this.DOM_ELEMENTS.notesButton.click();
        this.DOM_ELEMENTS.notesTextField.focus();
      } else if (this.DOM_ELEMENTS.inputTextField.value.length === 0) {
        // form is open and we're not trying to add notes: if nothing is written, then cancel
        this.DOM_ELEMENTS.cancelInput.click();
      } else {
        // add if content exists
        this.DOM_ELEMENTS.acceptInput.click();
      }
    } else {
      // handle enter on &lt;task>
      const shadow = this.DOM_ELEMENTS.taskList.children[this.focusIdx - 1].shadowRoot;
      const childNodes = Array.from(shadow.children);
      // expand button is the 6th child
      childNodes[5].click();
    }
  }

  handleRightArrow(event) {
    if (this.focusIdx !== 0 || (this.focusIdx === 0 &amp;&amp; this.isTimerInSession())) {
      event.preventDefault();

      let shadow;
      if (this.focusIdx === 0) {
        shadow = this.DOM_ELEMENTS.taskList.children[0].shadowRoot;
      } else {
        shadow = this.DOM_ELEMENTS.taskList.children[this.focusIdx - 1].shadowRoot;
      }

      const childNodes = Array.from(shadow.children);
      this.dprint(`shadowChildren: ${childNodes}`);
      // checkbox is the 3rd child
      childNodes[2].click();
      if (this.DOM_ELEMENTS.taskList.children.length === 0 || this.DOM_ELEMENTS.taskList.children.length === 1) {
        this.focusIdx = this.DOM_ELEMENTS.taskList.children.length;
      }
    }
  }

  handleExpand(event) {
    // click the expansion label if shown
    if (this.DOM_ELEMENTS.expansionLabel.style.display &amp;&amp; this.DOM_ELEMENTS.expansionLabel.style.display !== 'none') {
      event.preventDefault();
      this.DOM_ELEMENTS.expansionLabel.click();
    }
  }

  modDown() {
    this.modStatus = true;
  }

  modUp() {
    this.modStatus = false;
  }

  /**
   * Unclick the elements (assumes that at least one task is clicked)
   * No click tracking implemented so the unclicking function is bad
   */
  unclickItems() {
    if (this.DOM_ELEMENTS.taskList.children.length > 1) {
      this.DOM_ELEMENTS.taskList.children[
        this.DOM_ELEMENTS.taskList.children.length - 2
      ].click();
      this.DOM_ELEMENTS.taskList.children[
        this.DOM_ELEMENTS.taskList.children.length - 1
      ].click();
    }
    this.DOM_ELEMENTS.taskList.children[
      this.DOM_ELEMENTS.taskList.children.length - 1
    ].click();
  }

  /**
  * updates the index (in case of mouse selection) then increments the index
  * idx = 0 is mapped to adding a task
  * idx > 0 is mapped to tasks in order
  */
  incrementIdx() {
    // TODO: update idx from mouse click (BLOCKAGE!!! No good way to track tasks)
    // increment if there are tasks
    if (this.DOM_ELEMENTS.taskList.children.length > 0) {
      this.focusIdx = ((this.focusIdx + 1)
      % (this.DOM_ELEMENTS.taskList.children.length + 1));
    } else {
      this.focusIdx = 0;
    }
  }

  decrementIdx() {
    // javascript does not implement circular modulo
    if (this.DOM_ELEMENTS.taskList.children.length > 0) {
      this.focusIdx = ((this.focusIdx - 1)
            % (this.DOM_ELEMENTS.taskList.children.length + 1)
            + (this.DOM_ELEMENTS.taskList.children.length + 1))
        % (this.DOM_ELEMENTS.taskList.children.length + 1);
    } else {
      this.focusIdx = 0;
    }
  }

  getInputElements() {
    return [
      this.DOM_ELEMENTS.inputBox,
      this.DOM_ELEMENTS.inputMultiField,
      this.DOM_ELEMENTS.inputTextField,
      this.DOM_ELEMENTS.cancelInput,
      this.DOM_ELEMENTS.acceptInput,
      this.DOM_ELEMENTS.notesButton,
      this.DOM_ELEMENTS.notesTextField,
      document.querySelector('task-input'),
    ];
  }

  isTimerInSession() {
    return this.DOM_ELEMENTS.expansionLabel.style.display
      &amp;&amp; this.DOM_ELEMENTS.expansionLabel.style.display !== 'none'
      &amp;&amp; this.DOM_ELEMENTS.expansionLabel.innerHTML === 'View All Tasks';
  }

  /**
  * Prints Iff. debug flag is set true
  * @param {*} x the string to print
  */
  dprint(x) {
    if (this.DEBUG) {
      console.log(x);
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Tue Mar 16 2021 21:09:36 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
